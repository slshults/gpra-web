# Auto-approve and auto-merge Dependabot PRs for posthog-python updates
# Since we restrict Dependabot to ONLY posthog-python (see dependabot.yml),
# all semver types (patch, minor, major) are auto-merged.
# https://docs.github.com/en/code-security/dependabot/working-with-dependabot/automating-dependabot-with-github-actions

name: Dependabot auto-merge

on: pull_request

permissions:
  contents: write
  pull-requests: write

jobs:
  dependabot:
    runs-on: ubuntu-latest
    # Only run for dependabot[bot] authored PRs
    if: github.actor == 'dependabot[bot]'
    steps:
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@5e5f99653566eb8f8b0c17c4ea89ae8d3cd1586e  # v2.2.0
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      # Safety check: only auto-merge if the dependency is posthog
      # This is defense-in-depth alongside the dependabot.yml allow filter
      - name: Verify dependency is posthog
        id: verify
        run: |
          DEP_NAME="${{ steps.metadata.outputs.dependency-names }}"
          echo "Dependency: $DEP_NAME"
          if [[ "$DEP_NAME" == "posthog" ]]; then
            echo "allowed=true" >> "$GITHUB_OUTPUT"
          else
            echo "allowed=false" >> "$GITHUB_OUTPUT"
            echo "::warning::Unexpected dependency '$DEP_NAME' - skipping auto-merge"
          fi

      - name: Auto-approve PR
        if: steps.verify.outputs.allowed == 'true'
        run: gh pr review --approve "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-merge PR
        if: steps.verify.outputs.allowed == 'true'
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
